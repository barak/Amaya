Index: Amaya/Makefile.in
===================================================================
--- Amaya.orig/Makefile.in	2008-07-08 12:13:24.000000000 +0100
+++ Amaya/Makefile.in	2008-09-21 21:52:05.000000000 +0100
@@ -14,7 +14,7 @@
 
 #MKP: adding davlib
 SUBDIRS	= @SUBDIRS@ tools thotlib batch annotlib @DAVDIR@ amaya
-EXTRA_SUBDIRS= $(BUILDRAPTOR) $(LIBWWW) $(WX_BUILDDIR) $(GL_BUILDDIR)
+EXTRA_SUBDIRS= $(BUILDRAPTOR) @BUILDLIBWWW@ $(WX_BUILDDIR) $(GL_BUILDDIR)
 
 prefix = @prefix@
 exec_prefix = @exec_prefix@
@@ -23,7 +23,7 @@
 
 srcdir	= $(THOTDIR)
 
-default : tools gl @BUILDWXWIDGETS@ @BUILDRAPTOR@ thotlib batch amaya_prog print_prog
+default : tools gl @BUILDWXWIDGETS@ @BUILDRAPTOR@ @BUILDLIBWWW@ thotlib batch amaya_prog print_prog
 
 amaya : tools thotlib amaya_prog print_prog
 
@@ -128,127 +128,8 @@
 #
 # Rules to rebuild the libWWW package
 #
-
-# MKP: adding libwwwdav
-AMAYA_LIBWWW_STANDARD_LIBS = \
-	libwwwapp \
-	libwwwhttp \
-	libwwwhtml \
-	libwwwmime \
-	libwwwcache \
-	libwwwstream \
-	libwwwfile \
-	libwwwdir \
-	libwwwtrans \
-	libwwwcore \
-	libwwwutils \
-	libwwwftp \
-	@MAKE_LIBWWW_RDF_PARSER@ \
-	libwwwzip \
-        @LIBDAV@
-
-libwww_config :
-	@(if [ ! -d $(THOTDIR)/../$(LIBWWW) ] ; then \
-	      $(ECHO) "Error libwww dir not found at $(THOTDIR)/../$(LIBWWW)" ; \
-	  fi)
-	@(if [ ! -d $(LIBWWW) ] ; then \
-		$(MKDIR) $(LIBWWW) ; \
-          fi)
-#MKP: adding --with-dav
-	@(localdir=`pwd` ; libwwwdir="$$localdir/../../$(LIBWWW)" ; \
-	  cd $(LIBWWW) ; unset LANG; \
-	  if [ ! -f Makefile -o ! -f wwwconf.h ] ; then \
-	  	$$libwwwdir/configure \
-			--build=@build_alias@ --host=@host_alias@ --target=@target_alias@ \
-			--disable-shared \
-			@WITHDAV@ \
-			--with-zlib; \
-		$(ECHO) "libwww is configured" ; \
-		$(ECHO) "patching wwwconf.h because appkit.h do not compile on macos, and it seems that appkit.h is not used in amaya" ; \
-		$(CP) wwwconf.h wwwconf.h.orig ; \
-		$(SED) "s/\(\#define HAVE_APPKIT_APPKIT_H 1\)/\/* \1 *\//" \
-			wwwconf.h.orig > wwwconf.h ; \
-                $(ECHO) "wwwconf.h patched !" ; \
-	  fi)
-
-libwww_make_module_md5 \
-libmd5 : force
-		@(localdir=`pwd`; \
-		 cd $(LIBWWW)/modules/md5 ; \
-		 $(MAKE) CC="$(CC)" CFLAGS="$(CFLAGS) $(EXPAT_OPTIONS)" \
-		 CPPFLAGS="$(CPPFLAGS) $(THOTINCLUDES) $(EXTRA_INCLUDES)" \
-	        	    libmd5.la)
-
-libwww_install_module_md5 : force
-		@(if [ -e libmd5.a -a ! -L libmd5.a ] ; then \
-			$(RM) libmd5.a ; \
-		  fi ; \
-		  if [ ! -L libmd5.a ] ; then \
-			$(LN_S) $(LIBWWW)/modules/md5/.libs/libmd5.a ./libmd5.a ; \
-		  fi)
-
-libwww_make_module_expat \
-libexpat : force
-		@(localdir=`pwd`; \
-		  cd $(LIBWWW)/modules/expat/ ; \
-		  $(MAKE) CC="$(CC)" CFLAGS="$(CFLAGS) $(EXPAT_OPTIONS) -DXML_AMAYA" \
-		  CPPFLAGS="$(CPPFLAGS)" \
-	        	    )
-
-libwww_install_module_expat : force
-		@(if [ -e libexpat.a -a ! -L libexpat.a ] ; then \
-			$(RM) libexpat.a ; \
-		  fi ; \
-		  if [ ! -L libexpat.a ] ; then \
-			$(LN_S) $(LIBWWW)/modules/expat/.libs/libexpat.a ./libexpat.a ; \
-		  fi)
-
-#libwww_make_module_idn \
-#libidn : force
-#		@(localdir=`pwd`; \
-#		  cd $(LIBWWW)/modules/idn/ ; \
-#		  $(MAKE) CC="$(CC)" CFLAGS="$(CFLAGS) $(EXPAT_OPTIONS) -DLIBWWW_USEIDN" \
-#		  CPPFLAGS="$(CPPFLAGS)" \
-#	        	    )
-
-#libwww_install_module_idn : force
-#		@(if [ -e libidn.a -a ! -L libidn.a ] ; then \
-#			$(RM) libidn.a ; \
-#		  fi ; \
-#		  if [ ! -L libidn.a ] ; then \
-#			$(LN_S) $(LIBWWW)/modules/idn/.libs/libidn.a ./libidn.a ; \
-#		  fi)
-
-libwww_make_standard_libs \
-$(AMAYA_LIBWWW_STANDARD_LIBS) : force
-		@(localdir=`pwd`; \
-		  all_libs="" ; \
-		  for lib in $(AMAYA_LIBWWW_STANDARD_LIBS) ; do \
-		      all_libs="$$all_libs $$lib.la" ; \
-		   done ; \
-		  cd $(LIBWWW)/Library/src ; \
-		  $(MAKE) CC="$(CC)" CFLAGS="$(CFLAGS) $(EXPAT_OPTIONS)" \
-		  CPPFLAGS="$(CPPFLAGS) $(THOTINCLUDES) $(EXTRA_INCLUDES)" \
-			     $$all_libs)
-
-libwww_install_standard : force
-		@(for lib in $(AMAYA_LIBWWW_STANDARD_LIBS) ; do \
-		    if [ -e $$lib.a -a ! -L $$lib.a ] ; then \
-			$(RM) $$lib.a ;  \
-		    fi ; \
-		    if [ ! -L $$lib.a ] ; then \
-			$(LN_S) $(LIBWWW)/Library/src/.libs/$$lib.a ./$$lib.a ; \
-		    fi ; \
-		done)
-
-#libwww_make_module_libs : libwww_make_module_md5 libwww_make_module_expat libwww_make_module_idn
-libwww_make_module_libs : libwww_make_module_md5 libwww_make_module_expat
-libwww_make : libwww_make_module_libs libwww_make_standard_libs
-#libwww_install_modules : libwww_install_module_md5 libwww_install_module_expat libwww_install_module_idn
-libwww_install_modules : libwww_install_module_md5 libwww_install_module_expat
-libwww_install : libwww_install_modules libwww_install_standard 
-
-libwww : libwww_config libwww_make
+libwww: force
+	$(MAKE) -C libwww
 		@($(ECHO) "libwww is installed")
 
 #
Index: Amaya/amaya/Makefile.libwww
===================================================================
--- Amaya.orig/amaya/Makefile.libwww	2008-09-21 16:10:32.000000000 +0100
+++ Amaya/amaya/Makefile.libwww	2008-09-21 21:54:24.000000000 +0100
@@ -18,39 +18,14 @@
 
 AMAYA_LIBWWW_OPTION_LIBS=
 
-#MKP: added -lwwwdav
-AMAYA_LIBWWW_LIBS= \
-		-L../$(LIBWWW)/Library/src/.libs \
-			$(LIBWWW_RDF_PARSER) \
-			-lwwwzip \
-			-lwwwapp \
-			-lwwwhtml \
-			-lwwwhttp \
-			-lwwwmime \
-			-lwwwftp \
-			-lwwwfile \
-			-lwwwdir \
-			-lwwwcache \
-			-lwwwstream \
-			-lwwwtrans \
-			-lwwwcore \
-			-lwwwutils \
-			$(WWWDAV) \
-		-L../$(LIBWWW)/modules/md5/.libs \
-			-lmd5 \
-			../$(LIBWWW)/modules/expat/.libs/libexpat.a
-#		-L../$(LIBWWW)/modules/expat/.libs \
-#			-lexpat \
+AMAYA_LIBWWW_LIBS= @LIBWWW_LDFLAGS@
 
 AMAYA_LIBWWW_EXTRA_LIBS=
 
-AMAYA_LIBWWW_INCLUDES= -I../libwww \
-		-I$(THOTDIR)/../libwww/Library/src \
-		-I$(THOTDIR)../libwww/modules/md5 \
-		-I$(THOTDIR)/../libwww/modules/expat/lib
+AMAYA_LIBWWW_INCLUDES= @LIBWWW_CFLAGS@
 
 # this dependency calls the ../Makefile rule that compiles libwww
-AMAYA_LIBWWW_SRC= amaya_comp_libwww
+AMAYA_LIBWWW_SRC= @BUILDLIBWWW@
 
-amaya_comp_libwww : force
+libwww : force
 		@(cd .. ; $(MAKE) libwww)
Index: Amaya/configure.in
===================================================================
--- Amaya.orig/configure.in	2008-09-19 22:22:13.000000000 +0100
+++ Amaya/configure.in	2008-09-21 21:34:28.000000000 +0100
@@ -689,6 +689,27 @@
 	esac],
 	[with_svg="yes"])
 
+#################### LibWWW and WebDAV Support ################################
+
+AC_ARG_ENABLE([system-libwww],
+	AC_HELP_STRING([--enable-system-libwww],[try the libWWW system library]),
+	[case "${enableval}" in
+	  yes) with_system_libwww="yes" ;;
+	  no)  with_system_libwww="no" ;;
+	  *) AC_MSG_ERROR([bad value ${enableval} for --enable-system-libwww]) ;;
+	esac],
+	[with_system_libwww="no"])
+
+if test "$with_system_libwww" = "yes" ; then
+    # check to see if we have a libWWW library
+    AC_PATH_PROG([LIBWWW_CONFIG],[libwww-config])
+
+    if test "$LIBWWW_CONFIG" = "" ; then
+		AC_MSG_WARN(Not using system-provided libWWW, falling back to the builtin version.)
+		with_system_libwww="no"
+    fi
+fi
+
 dnl
 dnl WebDAV support enabled by default
 dnl
@@ -710,30 +731,66 @@
 fi
 
 if test "$with_dav" = "yes" ; then
+   WITHDAV="--with-dav"
+else
+   WITHDAV="--without-dav"
+fi
+
+if test "$enable_system_libwww" != "yes" ; then
+  # configure libwww
+  CURRENT_PATH="`pwd`"
+  mkdir libwww
+  cd libwww && \
+    $CURRENT_PATH/../../libwww/configure \
+    --build=$build_alias --host=$host_alias --target=$target_alias \
+    --disable-shared \
+    $WITHDAV \
+    --with-zlib && \
+    echo "libwww is configured" ; \
+    echo "patching wwwconf.h because appkit.h do not compile on macos, and it seems that appkit.h is not used in amaya" ; \
+    cp wwwconf.h wwwconf.h.orig ; \
+    sed -e "s/\(\#define HAVE_APPKIT_APPKIT_H 1\)/\/* \1 *\//" \
+			wwwconf.h.orig > wwwconf.h ; \
+    echo "wwwconf.h patched !" ; \
+  cd ..
+  chmod +x libwww/libwww-config
+  BUILDLIBWWW="libwww"
+  LIBWWW_CONFIG="libwww/libwww-config"
+  LIBWWW_LDFLAGS="-L$CURRENT_PATH/libwww/Library/src/.libs -L$CURRENT_PATH/libwww/modules/md5/.libs -L$CURRENT_PATH/libwww/modules/expat/.libs `$LIBWWW_CONFIG --libs`"
+  LIBWWW_CFLAGS="-I$CURRENT_PATH/../../libwww/Library/src -I$CURRENT_PATH/libwww"
+else
+  LIBWWW_CFLAGS="`$LIBWWW_CONFIG --cflags`"
+  LIBWWW_LDFLAGS="`$LIBWWW_CONFIG --libs`"
+
+  if test "$with_dav" = "yes" ; then
+    AC_CHECK_LIB([wwwdav],
+				 [toto],
+				 [LIBWWW_LDFLAGS="$LIBWWW_LDFLAGS -lwwwdav"],
+				 [AC_MSG_WARN([libwwwdav is not available, disabling WebDAV]); with_dav="no"])
+  fi
+fi
+
+if test "$with_dav" = "yes" ; then
    DAV_OPTIONS=-DDAV
    DAVDIR="davlib"
-   LIBDAV="libwwwdav"
-   WITHDAV="--with-dav" 
-   WWWDAV="-lwwwdav" 
+   LIBWWW_LDFLAGS="$LIBWWW_LDFLAGS -lwwwdav"
 else
    with_dav="no"
    DAV_OPTIONS=""
    DAVDIR=""
-   LIBDAV=""
-   WITHDAV="" 
-   WWWDAV="" 
 fi
 
-CURRENTPATH="`pwd`"
-LIBWWW_CFLAGS="-I$CURRENTPATH/../../libwww/Library/src -I$CURRENTPATH/../../libwww/modules/expat/lib -I$CURRENTPATH/../../libwww"
+AC_SUBST(BUILDLIBWWW)
 
 AC_SUBST(LIBWWW_CFLAGS)
+AC_SUBST(LIBWWW_LDFLAGS)
 
 AC_SUBST(DAVDIR)
 AC_SUBST(LIBDAV)
-AC_SUBST(WITHDAV)
 AC_SUBST(WWWDAV)
 
+############# end of LibWWW and WebDAV Support ################################
+
 ##########################Annotations Support####################
 dnl
 dnl annotations are enabled by default
@@ -880,12 +937,6 @@
 
 
 if test "$build_amaya" = "yes" ; then
-    if test ! -f $srcdir/../libwww/Makefile.in ; then
-	AC_MSG_WARN(libwww sources not found !!)
-	AC_MSG_WARN(Disabling Amaya build !)
-	build_amaya="no"
-    fi
-
     if test ! -f $srcdir/amaya/MathML.S ; then
 	if test "$with_math" = "yes" ; then
 	    AC_MSG_WARN(MathML sources not found !!)
