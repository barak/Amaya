#!/usr/bin/make -f
# Made with the aid of dh_make, by Craig Small
# Sample debian/rules that uses debhelper. GNU copyright 1997 by Joey Hess.

#export DH_VERBOSE=1

SOURCE:=amaya-src-8.5.tgz

DEB_BUILD_GNU_TYPE := $(shell dpkg-architecture -qDEB_BUILD_GNU_TYPE)
DEB_HOST_GNU_TYPE := $(shell dpkg-architecture -qDEB_HOST_GNU_TYPE)

build: build-stamp
build-stamp: patch-stamp
	dh_testdir

	# I copy the config.* because the amaya's copy doesn't
	# cover all of debian's archs
	cd Amaya && \
		cp /usr/share/misc/config.{sub,guess} . \
		&& autoconf && autoheader

	#cp debian/acinclude.m4 libwww
	cd libwww && \
		cp /usr/share/misc/config.{sub,guess} . && \
		aclocal-1.6 && \
		automake-1.6 && \
		libtoolize --force --copy && \
		autoconf

	# build gtk version
	-mkdir Amaya/BUILD
	cd Amaya/BUILD && ../configure --prefix=/usr --datadir=/usr/lib \
		--without-graphic-libs --with-dav --with-gtk \
		--build=$(DEB_BUILD_GNU_TYPE) --host=$(DEB_HOST_GNU_TYPE)

	cd Amaya/BUILD && make CFLAGS="-O2 -g -Wall" all amaya
	touch build-stamp

patch: patch-stamp
patch-stamp: source-stamp
	if [ -d debian/patches ]; then \
	set -e; for i in debian/patches/*; do \
		patch -p0 -s < $$i; \
	done; fi

	touch patch-stamp

source: source-stamp
source-stamp:
	tar zxf $(SOURCE)
	touch source-stamp

clean:
	dh_testdir
	dh_testroot
	-rm -f *-stamp

	-rm -rf Amaya libwww redland

	dh_clean

# Build architecture-independent files here.
binary-indep: build
	dh_testdir
	dh_testroot
	dh_clean -k -i
	dh_installdirs -i
	dh_installdocs -i
	dh_installexamples -i
	dh_installmenu -i
#	dh_installmanpages
#	dh_undocumented
	dh_installchangelogs -i
	dh_strip -i
	dh_compress -i
	dh_fixperms -i
	dh_installdeb -i
	dh_shlibdeps -i
	dh_gencontrol -i
	dh_md5sums -i
	dh_builddeb -i

# Build architecture-dependent files here.
binary-arch: build
#	dh_testversion
	dh_testdir
	dh_testroot
	dh_clean -k -a
	dh_installdirs -a
	dh_installmime -a

	cd Amaya/BUILD && $(MAKE) install prefix=`pwd`/../../debian/amaya/usr/lib datadir=`pwd`/../../debian/amaya/usr/lib
	-rm -rf debian/amaya/usr/lib/bin
	ln -s ../lib/Amaya/applis/bin/amaya debian/amaya/usr/bin/amaya
	#mv debian/amaya/usr/lib/Amaya/doc debian/amaya/usr/share/doc/amaya/doc
	#ln -s ../../share/doc/amaya/doc debian/amaya/usr/lib/Amaya/doc

	# Add stuff the makefile forgot
	install -m 0644 Amaya/amaya/AmayaPage.html \
		debian/amaya/usr/lib/Amaya/amaya
	install -m 0644 debian/amaya.1 debian/amaya/usr/share/man/man1
	cp Amaya/amaya/*.{en,fr,TRA,STR,PRS,trans,gif,conf} \
		debian/amaya/usr/lib/Amaya/amaya

	chmod -R o+w debian/amaya/usr/lib/Amaya

	dh_installdocs -a
	dh_installexamples -a
	dh_installmenu -a
#	dh_installmanpages
#	dh_undocumented
	dh_installchangelogs -a
	dh_strip -a
	dh_compress -a
	dh_fixperms -a
	dh_installdeb -a
	dh_shlibdeps -a
	dh_gencontrol -a
#	dh_makeshlibs
	dh_md5sums -a
	dh_builddeb -a

#source diff:                                                                  
#	@echo >&2 'source and diff are obsolete - use dpkg-source -b'; false

binary:  binary-arch
.PHONY: build clean binary-indep binary-arch binary
